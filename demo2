test DECLARE  lv_v_body               VARCHAR2(32000);  lv_v_body_html          VARCHAR2(32000);  lv_request_id           NUMBER;  l_url                   VARCHAR2(32000);  l_app                   NUMBER      := 2009;  l_session               NUMBER      := :APP_SESSION;  lv_v_crlf               VARCHAR2(2) := chr(13)||chr(10);  v_employee_name         VARCHAR2(100);  v_source_city_id        NUMBER;  v_destination_city_id   NUMBER;  v_email_address         VARCHAR2(100);  lv_mail_response        VARCHAR2(32000);  lv_travel_details       VARCHAR2(300);  lv_reporting_time       VARCHAR2(300);  lv_project_name         VARCHAR2(300);  lv_travel_update_id     NUMBER;  lv_travel_count         NUMBER;  lv_customer_name        VARCHAR2(100);  lv_sales_executive_mail VARCHAR2(100);  lv_sales_executive_rmg  VARCHAR2(100);  lv_project_manager      VARCHAR2(100);
BEGIN  BEGIN    SELECT PRJ.PROJECT_NAME,      EMP.EMAIL_ADDRESS    INTO lv_project_name,      lv_sales_executive_mail      /*Added by Bharath Raju 5-Mar-2020*/    FROM XXPRODUCT.XXFS_PM_PROJECTS_T PRJ,      XXPRODUCT.XXFS_PM_EMPLOYEES_T EMP    WHERE EMP.EMPLOYEE_ID =PRJ.SALES_EXECUTIVE    AND PRJ.PROJECT_ID    = :P785_PROJECTNAME;  EXCEPTION  WHEN OTHERS THEN    lv_project_name:=NULL;    XXFS_PM_ERROR_LOG_PKG.RECORD_LOG ('ERROR','SEND MAIL TO CLIENT-CSAT','BLOCK1',1);  END;  BEGIN    SELECT EMP.EMAIL_ADDRESS    INTO lv_project_manager    FROM XXPRODUCT.XXFS_PM_PROJECT_MANAGERS_V PMG,      XXPRODUCT.XXFS_PM_EMPLOYEES_T EMP    WHERE PMG.PROJECT_MANAGER_ID = EMP.EMPLOYEE_ID    AND PMG.PROJECT_ID           =:P785_PROJECTNAME;  EXCEPTION  WHEN OTHERS THEN    lv_project_name:=NULL;    XXFS_PM_ERROR_LOG_PKG.RECORD_LOG ('ERROR','SEND MAIL TO CLIENT-CSAT','BLOCK11',1);  END;  /* Added by Bharath Raju 31-Mar-2020*/  BEGIN    SELECT RMG.EMAIL_ADDRESS    INTO lv_sales_executive_rmg    FROM XXPRODUCT.XXFS_PM_PROJECTS_T PRJ,      XXPRODUCT.XXFS_PM_EMPLOYEES_T EMP,      XXPRODUCT.XXFS_PM_EMPLOYEES_T RMG    WHERE EMP.EMPLOYEE_ID =PRJ.SALES_EXECUTIVE    AND RMG.EMPLOYEE_ID   =EMP.REPORTING_MGR_ID    AND PRJ.PROJECT_ID    = :P785_PROJECTNAME;  EXCEPTION  WHEN OTHERS THEN    lv_sales_executive_rmg:=NULL;    XXFS_PM_ERROR_LOG_PKG.RECORD_LOG ('ERROR','SEND MAIL TO CLIENT-CSAT','BLOCK10',1);  END;  /*Added by Bharath Raju 5-Mar-2020*/  BEGIN    SELECT customer_name    INTO lv_customer_name    FROM XXFS_PM_CUSTOMERS_T    WHERE customer_id = :P28_CUSTOMER_ID;  EXCEPTION  WHEN OTHERS THEN    lv_project_name:=NULL;    XXFS_PM_ERROR_LOG_PKG.RECORD_LOG ('ERROR','SEND MAIL TO CLIENT-CSAT','BLOCK3',1);  END;  l_url := APEX_UTIL.PREPARE_URL( p_url => 'f?p=' || l_app || ':1:'||'::NO::P1_PROJECT_ID,P1_CSAT_MASTER_ID:'||:P785_PROJECTNAME||','||:P785_CSAT_MASTERID);  /*    l_url := APEX_UTIL.PREPARE_URL(  p_url => 'f?p=' || l_app || ':1:'||l_session||'::NO::P1_TRAVEL_REQUEST_ID:'||i.req_id,  p_checksum_type => '1');*/  lv_v_body      := 'To view the content of this message, please use an HTML enabled mail client.'|| lv_v_crlf;  lv_v_body_html := '<html><head>                      <style type="text/css">                      body{font-family: Tahoma, Arial, Helvetica, sans-serif;                      font-size:10pt;                      color:#002060;                      margin:30px;                      background-color:#ffffff;}                      span.sig{font-style:italic;                      font-weight:bold;                      color:#811919;}                      </style>                      </head><body>    
<br/><br/><tr height="20"><td>Dear '||:P785_CUSTOMERNAME||  ',<br><br/>We take this opportunity to thank you for trusting and choosing 4iApps for your business requirements and deliverables.  When we complete projects with clients, we finish up with a survey from our clients and get to know their thoughts, inputs and satisfaction level with regards to our project deliverables. <br></br> The survey takes just few minutes to complete and by giving us your feedback and experience of working with us, we can go a long way to further improvise on our offerings and deliverables.  Every CSAT inputs received from our clients are analyzed for the results and forms as a critical input to our Senior Management team. <br> 
</td></tr><br/><br/><U></U>

<a href="'  --||'http://172.16.2.107:8080/ords/'||l_url||'">Click here to upload your details.'|| '</a> </p>' || utl_tcp.crlf || '  ||'https://products.4iapps.com/ords/'||l_url||'"><b>Click here to begin the Survey.</b>'|| '</a> </p>' || utl_tcp.crlf || '  
<br/>'|| '<span style="color:red"></span>' ;  -- <tr height="20"><td>' || v_source_city_id ||' '||v_destination_city_id|| '</td></tr>';  lv_v_body_html := lv_v_body_html ||'Regards,<br/>Operations Team – 4iApps' || lv_v_crlf;  /*lv_mail_response := xxfs_pm_send_mail( 'PMO Desk "@" 4i Apps<pmo_desk@4iapps>', --p_from  :P28_CUSTOMER_EMAIL,--'priyanka.t@4iapps.com',  --  P_TO  NULL,  --P_CC  'richard.d@4iapps.com,bharath.raju@4iapps.com', --p_bcc  'CSAT Survey : '||lv_project_name,   --p_subject  lv_v_body, --p_body  lv_v_body_html --p_html_body  );  */  apex_mail.send (p_to => :P785_ADDRESS,   p_cc => lv_sales_executive_mail||','||lv_sales_executive_rmg||','||lv_project_manager,   p_bcc => 'pmo@4iapps.com',  p_from => 'PMO Desk "@" 4i Apps<PMO_Desk@4iapps.com>',   p_subj => 'CSAT Survey : '||lv_project_name ,  p_body => lv_v_body,   p_body_html => lv_v_body_html );    APEX_MAIL.PUSH_QUEUE(P_SMTP_HOSTNAME => '4IAPPS-COM.MAIL.PROTECTION.OUTLOOK.COM', P_SMTP_PORTNO => 25);
EXCEPTION
WHEN OTHERS THEN  XXFS_PM_ERROR_LOG_PKG.RECORD_LOG ('ERROR','CSAT CLIENT MAIL','FINAL BLOCK',1);
END;

